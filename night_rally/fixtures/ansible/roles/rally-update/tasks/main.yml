---

# this is handy for verifying whether skipping a Rally update was explicitly asked
- debug: var=skip_rally_update

- name: start rallyd
  # explicitly unset JAVA_HOME until https://github.com/ansible/ansible/pull/60081 lands on an Ansible release
  command: >
    /bin/bash --login
    -c "env -u JAVA_HOME bin/rallyd {% if skip_rally_update | default(False) | bool %}--skip-update{% endif %} start --node-ip {{ inventory_hostname }} --coordinator-ip {{ groups['coordinating_nodes'][0] }}"
  args:
    chdir: /var/lib/jenkins
  environment:
    GOOGLE_APPLICATION_CREDENTIALS: /var/lib/jenkins/.gcs-service-account.json
    JAVA7_HOME: /var/lib/jenkins/.java/java7
    JAVA8_HOME: /var/lib/jenkins/.java/java8
    JAVA9_HOME: /var/lib/jenkins/.java/java9
    JAVA10_HOME: /var/lib/jenkins/.java/java10
    JAVA11_HOME: /var/lib/jenkins/.java/openjdk11
    JAVA12_HOME: /var/lib/jenkins/.java/openjdk12
    JAVA13_HOME: /var/lib/jenkins/.java/openjdk13
    JAVA14_HOME: /var/lib/jenkins/.java/openjdk14
    JAVA15_HOME: /var/lib/jenkins/.java/openjdk15
    JAVA16_HOME: /var/lib/jenkins/.java/openjdk16
  become: true
  become_user: jenkins
  when: not in_vagrant | default("false") | bool

- name: start rallyd in vagrant env, if applicable
  command: >
    /bin/bash --login
    -c "env -u JAVA_HOME bin/rallyd {% if skip_rally_update | default(False) | bool %}--skip-update{% endif %} start --node-ip {{ inventory_hostname }} --coordinator-ip {{ groups['coordinating_nodes'][0] }}"
  args:
    chdir: /var/lib/jenkins
  environment:
    GOOGLE_APPLICATION_CREDENTIALS: /var/lib/jenkins/.gcs-service-account.json
    JAVA8_HOME: /usr/lib/jvm/java-8-openjdk-amd64
    JAVA11_HOME: /var/lib/jenkins/.java/openjdk11
    JAVA12_HOME: /var/lib/jenkins/.java/openjdk12
    JAVA13_HOME: /var/lib/jenkins/.java/openjdk13
    JAVA14_HOME: /var/lib/jenkins/.java/openjdk14
    JAVA15_HOME: /var/lib/jenkins/.java/openjdk15
    JAVA16_HOME: /var/lib/jenkins/.java/openjdk16
  become: true
  become_user: jenkins
  when: in_vagrant | default("false") | bool
