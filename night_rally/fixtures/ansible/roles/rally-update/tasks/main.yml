---

- name: stop rallyd
  command: ./rallyd stop
  args:
    chdir: /var/lib/jenkins/bin
  become: true
  become_user: jenkins
  ignore_errors: true

- name: ensure all rally daemon processes have been killed
  command: killall -9 esrallyd
  ignore_errors: true
  become: true

- name: start rallyd
  command: ./rallyd --skip-update start --node-ip {{ inventory_hostname }} --coordinator-ip {{ groups['coordinating-nodes'][0] }}
  args:
    chdir: /var/lib/jenkins/bin
  environment:
    JAVA7_HOME: /var/lib/jenkins/.java/java7
    JAVA8_HOME: /var/lib/jenkins/.java/java8
    JAVA9_HOME: /var/lib/jenkins/.java/java9
    JAVA10_HOME: /var/lib/jenkins/.java/java10
    JAVA11_HOME: /var/lib/jenkins/.java/openjdk11
    JAVA12_HOME: /var/lib/jenkins/.java/openjdk12
    JAVA13_HOME: /var/lib/jenkins/.java/openjdk13
  become: true
  become_user: jenkins
  when: not in_vagrant | default("false") | bool

- name: start rallyd in vagrant env, if applicable
  command: ./rallyd --skip-update start --node-ip {{ inventory_hostname }} --coordinator-ip {{ groups['coordinating-nodes'][0] }}
  args:
    chdir: /var/lib/jenkins/bin
  environment:
    JAVA8_HOME: /usr/lib/jvm/java-8-openjdk-amd64
    JAVA11_HOME: /var/lib/jenkins/.java/openjdk11
    JAVA12_HOME: /var/lib/jenkins/.java/openjdk12
    JAVA13_HOME: /var/lib/jenkins/.java/openjdk13
  become: true
  become_user: jenkins
  when: in_vagrant | default("false") | bool
